<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon RPG: V31 Fixed</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: #000; overflow: hidden; font-family: 'Rajdhani', sans-serif; height: 100vh; width: 100vw; color: white; }
        canvas { display: block; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
        
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; z-index: 10; }
        
        /* OVERLAYS (JANELAS) */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 10, 0.95); z-index: 100; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; pointer-events: auto; backdrop-filter: blur(10px); }
        
        /* ESTILOS GERAIS DE BOT√ÉO E TEXTO */
        .neon-text { font-family: 'Orbitron'; color: #00ffff; text-shadow: 0 0 10px #00ffff; letter-spacing: 2px; }
        .btn { background: rgba(20, 20, 25, 0.9); border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; font-family: 'Orbitron'; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.1s; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.95); border-color: #fff; }
        .btn:disabled { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; }

        /* START SCREEN */
        #start-overlay { display: flex; z-index: 200; background: #000; }
        .class-card { width: 100%; max-width: 350px; background: rgba(30,30,35,1); border: 1px solid #333; padding: 20px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .class-card:active { background: #444; }
        .c-icon { font-size: 24px; }

        /* MAPA */
        .map-header { width: 100%; max-width: 400px; text-align: center; margin-top: 20px; }
        .header-btns { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .map-grid { display: flex; flex-direction: column-reverse; gap: 15px; width: 100%; max-width: 350px; padding-bottom: 50px; }
        .map-node { background: #111; border: 1px solid #333; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; opacity: 0.5; }
        .map-node.unlocked { opacity: 1; border-color: #00ff00; cursor: pointer; }
        .map-node.active { border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.2); transform: scale(1.02); }

        /* BATTLE HUD */
        .hud-top { width: 100%; max-width: 500px; margin: 0 auto; pointer-events: auto; display: flex; justify-content: space-between; align-items: flex-start; position: relative; }
        .bars-area { width: 60%; }
        .bar-container { width: 100%; height: 12px; background: #222; border: 1px solid #555; border-radius: 4px; margin-bottom: 5px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s; }
        .hp { background: linear-gradient(90deg, #ff4444, #ff0000); }
        .mp { background: linear-gradient(90deg, #0088ff, #00ffff); }
        .stats-area { text-align: right; font-family: 'Orbitron'; font-size: 12px; }
        .exit-btn { width: 30px; height: 30px; background: rgba(255,0,0,0.3); border: 1px solid #ff0000; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }

        .battle-log { position: absolute; bottom: 100px; left: 20px; right: 20px; height: 100px; pointer-events: none; display: flex; flex-direction: column-reverse; overflow: hidden; mask-image: linear-gradient(to top, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to top, black 50%, transparent 100%); }
        .log-msg { font-family: 'Share Tech Mono'; font-size: 12px; text-shadow: 1px 1px 0 #000; margin-bottom: 2px; }

        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; pointer-events: auto; margin-bottom: 20px; width: 100%; max-width: 500px; align-self: center; }
        #btn-s1 { border-color: #ff4444; color: #ffcccc; }
        #btn-s2 { border-color: #00ffff; color: #ccffff; }
        #btn-s3 { border-color: #b026ff; color: #e0b0ff; }
        #btn-rest { border-color: #ffff00; color: #ffffcc; }

        /* SHOP & PROFILE */
        .skill-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 400px; }
        .skill-card { background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 10px; border-radius: 8px; text-align: center; }
        .prof-stats { width: 100%; max-width: 300px; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 5px 0; font-family: 'Share Tech Mono'; }

        .toast { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold; color: #fff; text-shadow: 0 0 5px #000; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 300; }
        .toast.show { opacity: 1; transform: translate(-50%, -80%); }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <div id="start-overlay" class="overlay" style="display:flex;">
        <h1 class="neon-text" style="font-size: 32px; margin-bottom: 40px; margin-top: 50px;">NEON PROTOCOL</h1>
        <div class="class-card" onclick="startGame('samurai')" style="border-left: 4px solid #ff0055">
            <div><div style="color:#ff0055; font-weight:bold;">L√ÇMINA</div><small style="color:#888">Cr√≠tico + Dano</small></div><div class="c-icon">‚öîÔ∏è</div>
        </div>
        <div class="class-card" onclick="startGame('mage')" style="border-left: 4px solid #00ffff">
            <div><div style="color:#00ffff; font-weight:bold;">C√ìDIGO</div><small style="color:#888">Magia + MP</small></div><div class="c-icon">‚ú®</div>
        </div>
        <div class="class-card" onclick="startGame('tank')" style="border-left: 4px solid #00ff00">
            <div><div style="color:#00ff00; font-weight:bold;">FIREWALL</div><small style="color:#888">Defesa Alta</small></div><div class="c-icon">üõ°Ô∏è</div>
        </div>
        <p style="color:#444; margin-top:auto; font-size:10px;">V31 SYSTEM STABLE</p>
    </div>

    <div id="map-overlay" class="overlay">
        <div class="map-header">
            <h1 class="neon-text">MAPA DE REDE</h1>
            <p id="map-sector-name" style="color:#888; font-size:12px; margin-bottom:10px;">SETOR 1</p>
            <div class="header-btns">
                <button class="btn" style="border-color:#00ffff; color:#00ffff" onclick="openProfile()">PERFIL</button>
                <button class="btn" style="border-color:#00ff00; color:#00ff00" onclick="alert('Invent√°rio Vazio')">ITEMS</button>
                <button class="btn" style="border-color:#b026ff; color:#b026ff" onclick="openShop()">LOJA</button>
            </div>
        </div>
        <div class="map-grid" id="map-grid"></div>
    </div>

    <div class="ui-layer" id="game-ui" style="display:none;">
        <div class="hud-top">
            <div class="bars-area">
                <div class="bar-container"><div id="hp-bar" class="bar-fill hp"></div></div>
                <div class="bar-container"><div id="mp-bar" class="bar-fill mp"></div></div>
            </div>
            <div class="stats-area">
                <div style="color:white; font-weight:bold;">SETOR <span id="sector-disp">1</span></div>
                <div style="color:#b026ff">üü£ <span id="essence-disp">0</span></div>
            </div>
            <div class="exit-btn" onclick="exitBattle()">X</div>
        </div>
        
        <div class="battle-log" id="battle-log"></div>
        <div id="toast-msg" class="toast"></div>
        
        <div class="controls">
            <button class="btn" id="btn-s1" onclick="performAction(1)">ATK</button>
            <button class="btn" id="btn-s2" onclick="performAction(2)">SKILL</button>
            <button class="btn" id="btn-s3" onclick="performAction(3)">ULT</button>
            <button class="btn" id="btn-rest" onclick="performAction(0)">REST</button>
        </div>
    </div>

    <div id="shop-overlay" class="overlay">
        <h1 class="neon-text" style="color:#ff4444; text-shadow:0 0 10px #ff0000; margin-top:20px;">SINAL PERDIDO</h1>
        <h2 style="color:#b026ff; margin-bottom:20px;">üü£ <span id="shop-essence">0</span></h2>
        <div class="skill-grid" id="shop-grid"></div>
        <button class="btn" style="width:200px; margin-top:20px; border-color:#ff4444; color:#ff4444;" onclick="closeOverlays()">VOLTAR</button>
    </div>

    <div id="profile-overlay" class="overlay">
        <h1 class="neon-text" style="margin-top:30px;">PERFIL</h1>
        <div class="prof-stats" id="prof-stats-container"></div>
        <button class="btn" style="width:200px; border-color:#fff;" onclick="closeOverlays()">VOLTAR</button>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const CLASS_STATS = { 
            samurai: { name: "L√¢mina", color: "#ff0055", hpMult: 0.9, mpMult: 0.8, atkBonus: 8, defBonus: 0 }, 
            mage: { name: "C√≥digo", color: "#00ffff", hpMult: 0.7, mpMult: 1.6, atkBonus: 2, defBonus: 0 }, 
            tank: { name: "Firewall", color: "#00ff00", hpMult: 1.5, mpMult: 0.6, atkBonus: -2, defBonus: 4 } 
        };
        const SKILLS = {
            samurai: [{name:"CORTE", cost:0}, {name:"POSTURA", cost:0}, {name:"GOLPE", cost:20}],
            mage: [{name:"RAIO", cost:10}, {name:"ESCUDO", cost:15}, {name:"EXPLOS√ÉO", cost:40}],
            tank: [{name:"BASH", cost:0}, {name:"FORTIFY", cost:10}, {name:"COUNTER", cost:15}]
        };
        const SECTOR_NAMES = { 1: "GRID", 2: "FIREWALL", 3: "VOID" };

        // --- SAVE SYSTEM ---
        const DEFAULT_SAVE = { essence: 0, skills: { atk: 0, hp: 0, mp: 0, def: 0, crit: 0, spd: 0 }, progress: { sector: 1, node: 1 } };
        let saveData = JSON.parse(localStorage.getItem('neonRpgV31')) || DEFAULT_SAVE;
        if(!saveData.progress) saveData.progress = {sector:1, node:1};
        function saveGame() { localStorage.setItem('neonRpgV31', JSON.stringify(saveData)); }

        // --- GLOBAL STATE ---
        let state = { 
            currentClass: 'samurai', 
            hp: 100, maxHp: 100, mp: 50, maxMp: 50, 
            enemyHp: 0, enemyMaxHp: 0, 
            sector: 1, node: 1, 
            turn: 'player', 
            particles: [], shake: 0 
        };
        
        let assets = { player: new Image(), enemy: new Image() }; // Imagens
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // --- INITIALIZATION ---
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        // Game Loop para desenho cont√≠nuo
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        requestAnimationFrame(gameLoop);

        // --- CORE FUNCTIONS ---
        function startGame(className) {
            state.currentClass = className;
            assets.player.src = `https://robohash.org/Neon${className}?set=set1`;
            
            document.getElementById('start-overlay').style.display = 'none';
            
            // Inicializa Stats
            recalcStats();
            state.hp = state.maxHp;
            state.mp = state.maxMp;
            
            showMap();
        }

        function recalcStats() {
            let cls = CLASS_STATS[state.currentClass];
            let baseHp = 100 + (saveData.skills.hp * 20);
            let baseMp = 50 + (saveData.skills.mp * 15);
            state.maxHp = Math.floor(baseHp * cls.hpMult);
            state.maxMp = Math.floor(baseMp * cls.mpMult);
            state.sector = saveData.progress.sector;
        }

        // --- MAP SYSTEM ---
        function showMap() {
            closeOverlays();
            document.getElementById('map-overlay').style.display = 'flex';
            document.getElementById('map-sector-name').innerText = `SETOR ${state.sector}: ${SECTOR_NAMES[state.sector] || 'UNKNOWN'}`;
            
            const grid = document.getElementById('map-grid');
            grid.innerHTML = '';
            
            let maxNode = (state.sector === saveData.progress.sector) ? saveData.progress.node : 11;

            for(let i=1; i<=10; i++) {
                let div = document.createElement('div');
                div.className = 'map-node';
                let icon = i===10 ? 'üíÄ' : 'üîπ';
                let txt = i===10 ? 'BOSS' : 'HOSTILE';
                
                if(i < maxNode) { 
                    div.classList.add('unlocked'); div.style.borderColor = '#00ffff'; icon='‚úÖ'; txt='COMPLETO';
                } else if(i === maxNode) { 
                    div.classList.add('unlocked', 'active'); 
                    div.onclick = () => enterNode(i); 
                } else {
                    icon = 'üîí';
                }

                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:white; font-size:14px;">N√ì ${state.sector}-${i}</div>
                        <div style="font-size:10px; color:#aaa;">${txt}</div>
                    </div>
                    <div style="font-size:20px;">${icon}</div>
                `;
                grid.appendChild(div);
            }
        }

        function enterNode(n) {
            state.node = n;
            state.hp = state.maxHp; // Cura ao entrar na fase
            state.mp = state.maxMp;
            closeOverlays();
            document.getElementById('game-ui').style.display = 'flex';
            startBattle();
        }

        // --- BATTLE SYSTEM ---
        function startBattle() {
            let isBoss = (state.node === 10);
            let diff = state.sector * 10 + state.node * 5;
            state.enemyMaxHp = 100 + diff;
            if(isBoss) state.enemyMaxHp *= 3;
            state.enemyHp = state.enemyMaxHp;
            state.turn = 'player';
            
            // Carrega imagem do inimigo (sem travar)
            let spriteId = isBoss ? `BOSS_${state.sector}` : `MOB_${state.sector}_${state.node}`;
            assets.enemy.src = `https://robohash.org/${spriteId}?set=set2`;

            // Atualiza Bot√µes
            let skills = SKILLS[state.currentClass];
            for(let i=0; i<3; i++) {
                let btn = document.getElementById(`btn-s${i+1}`);
                btn.innerHTML = `${skills[i].name}<br><span style="font-size:9px; color:#aaa">${skills[i].cost} MP</span>`;
            }

            addLog("Batalha iniciada!", "#ffff00");
            updateHUD();
            toggleButtons(true);
        }

        function performAction(idx) {
            if(state.turn !== 'player') return;

            let cls = CLASS_STATS[state.currentClass];
            let skillList = SKILLS[state.currentClass];
            
            // REST (0)
            if(idx === 0) {
                let rec = 20 + (saveData.skills.mp * 5);
                state.mp = Math.min(state.maxMp, state.mp + rec);
                addLog(`Descanso: +${rec} MP`, "#00ff00");
                updateHUD();
                state.turn = 'enemy';
                setTimeout(enemyTurn, 800);
                return;
            }

            // ATTACK / SKILLS
            let skill = skillList[idx-1];
            if(state.mp < skill.cost) {
                showToast("SEM MANA", "#00ffff");
                return;
            }

            state.mp -= skill.cost;
            
            // Dano Base
            let dmg = 15 + (saveData.skills.atk * 5) + cls.atkBonus;
            
            // Multiplicadores por Skill
            if(idx === 2) dmg = Math.floor(dmg * 1.5);
            if(idx === 3) dmg = Math.floor(dmg * 2.5);

            // Critico
            if(Math.random() < 0.1) { dmg *= 2; showToast("CR√çTICO!", "#ff0000"); }

            state.enemyHp -= dmg;
            spawnParticles(width*0.75, height*0.4, '#ffaa00', 20);
            screenShake(10);
            addLog(`Usou ${skill.name}: ${dmg} dano`, "#00ffff");

            updateHUD();

            if(state.enemyHp <= 0) {
                state.enemyHp = 0;
                setTimeout(handleVictory, 500);
            } else {
                state.turn = 'enemy';
                toggleButtons(false);
                setTimeout(enemyTurn, 1000);
            }
        }

        function enemyTurn() {
            let dmg = 10 + (state.sector * 3);
            let def = saveData.skills.def;
            let finalDmg = Math.max(1, dmg - def);

            state.hp -= finalDmg;
            spawnParticles(width*0.25, height*0.6, '#ff0000', 20);
            screenShake(10);
            addLog(`Inimigo causou ${finalDmg} dano`, "#ff4444");

            updateHUD();

            if(state.hp <= 0) {
                state.hp = 0;
                addLog("DERROTA", "#ff0000");
                setTimeout(() => { exitBattle(); alert("Voc√™ falhou. Tente novamente."); }, 1000);
            } else {
                state.turn = 'player';
                toggleButtons(true);
            }
        }

        function handleVictory() {
            let ess = 10 * state.sector;
            if(state.node === 10) ess *= 5;
            saveData.essence += ess;
            
            // Progresso
            if(state.sector === saveData.progress.sector && state.node === saveData.progress.node) {
                saveData.progress.node++;
                if(saveData.progress.node > 10) {
                    saveData.progress.sector++;
                    saveData.progress.node = 1;
                }
            }
            saveGame();
            showToast(`VIT√ìRIA! +${ess} ESS`, "#b026ff");
            setTimeout(exitBattle, 1500);
        }

        function exitBattle() {
            document.getElementById('game-ui').style.display = 'none';
            showMap();
        }

        // --- UI FUNCTIONS ---
        function updateHUD() {
            let hpPct = (state.hp / state.maxHp) * 100;
            let mpPct = (state.mp / state.maxMp) * 100;
            document.getElementById('hp-bar').style.width = hpPct + "%";
            document.getElementById('mp-bar').style.width = mpPct + "%";
            document.getElementById('sector-disp').innerText = state.sector;
            document.getElementById('essence-disp').innerText = saveData.essence;
        }

        function toggleButtons(enable) {
            let btns = document.querySelectorAll('.controls .btn');
            btns.forEach(b => b.disabled = !enable);
        }

        function addLog(msg, color) {
            let div = document.createElement('div');
            div.className = 'log-msg';
            div.style.color = color;
            div.innerText = "> " + msg;
            let container = document.getElementById('battle-log');
            container.prepend(div);
            if(container.children.length > 5) container.lastChild.remove();
        }

        function showToast(msg, color) {
            let t = document.getElementById('toast-msg');
            t.innerText = msg; t.style.color = color; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 1000);
        }

        function closeOverlays() {
            document.querySelectorAll('.overlay').forEach(el => {
                if(el.id !== 'start-overlay') el.style.display = 'none';
            });
        }

        // --- SHOP & PROFILE ---
        function openShop() {
            closeOverlays();
            document.getElementById('shop-overlay').style.display = 'flex';
            updateShopUI();
        }

        function updateShopUI() {
            document.getElementById('shop-essence').innerText = saveData.essence;
            let container = document.getElementById('shop-grid');
            container.innerHTML = '';
            
            const items = ['atk', 'hp', 'mp', 'def', 'crit', 'spd'];
            items.forEach(k => {
                let lvl = saveData.skills[k] || 0;
                let cost = 10 * (lvl + 1);
                let div = document.createElement('div');
                div.className = 'skill-card';
                div.innerHTML = `
                    <div style="font-weight:bold; color:white; text-transform:uppercase">${k}</div>
                    <div style="font-size:10px; color:#aaa">Nvl ${lvl}</div>
                    <button class="btn" style="width:100%; margin-top:5px; border-color:${saveData.essence >= cost ? '#00ff00' : '#ff4444'}" onclick="buySkill('${k}', ${cost})">UP (${cost})</button>
                `;
                container.appendChild(div);
            });
        }

        function buySkill(key, cost) {
            if(saveData.essence >= cost) {
                saveData.essence -= cost;
                saveData.skills[key] = (saveData.skills[key] || 0) + 1;
                saveGame();
                updateShopUI();
                recalcStats(); // Atualiza vida maxima imediatamente
            } else {
                alert("Ess√™ncia insuficiente!");
            }
        }

        function openProfile() {
            closeOverlays();
            document.getElementById('profile-overlay').style.display = 'flex';
            let c = document.getElementById('prof-stats-container');
            c.innerHTML = `
                <div class="stat-row"><span>CLASSE</span><span style="color:${CLASS_STATS[state.currentClass].color}">${CLASS_STATS[state.currentClass].name}</span></div>
                <div class="stat-row"><span>ATK</span><span>${15 + (saveData.skills.atk*5)}</span></div>
                <div class="stat-row"><span>HP M√ÅX</span><span>${state.maxHp}</span></div>
                <div class="stat-row"><span>MP M√ÅX</span><span>${state.maxMp}</span></div>
                <div class="stat-row"><span>DEFESA</span><span>${saveData.skills.def}</span></div>
            `;
        }

        // --- GRAPHICS ENGINE ---
        function update() {
            // Screen Shake logic
            if(state.shake > 0) state.shake *= 0.9;
            if(state.shake < 0.5) state.shake = 0;
            
            // Particles
            for(let i=state.particles.length-1; i>=0; i--) {
                let p = state.particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                if(p.life <= 0) state.particles.splice(i, 1);
            }
        }

        function draw() {
            // Background
            ctx.fillStyle = "#050505";
            ctx.fillRect(0, 0, width, height);
            
            // Grid Effect
            ctx.strokeStyle = state.sector === 1 ? "#003300" : (state.sector === 2 ? "#331100" : "#220033");
            ctx.lineWidth = 2;
            ctx.beginPath();
            let horizon = height * 0.4;
            for(let i=0; i<width; i+=40) { ctx.moveTo(i, horizon); ctx.lineTo(i - (width/2 - i)*2, height); }
            for(let i=horizon; i<height; i+=40) { ctx.moveTo(0, i); ctx.lineTo(width, i); }
            ctx.stroke();

            ctx.save();
            // Apply Shake
            if(state.shake > 0) ctx.translate((Math.random()-0.5)*state.shake, (Math.random()-0.5)*state.shake);

            // Draw Entities only if in battle
            if(document.getElementById('game-ui').style.display === 'flex') {
                let clsColor = CLASS_STATS[state.currentClass].color;
                
                // Player
                let px = width * 0.25, py = height * 0.65;
                if(assets.player.complete && assets.player.naturalWidth > 0) {
                    ctx.shadowColor = clsColor; ctx.shadowBlur = 20;
                    ctx.drawImage(assets.player, px-50, py-50, 100, 100);
                    ctx.shadowBlur = 0;
                } else {
                    // Fallback Circle
                    ctx.fillStyle = clsColor; ctx.beginPath(); ctx.arc(px, py, 30, 0, Math.PI*2); ctx.fill();
                }

                // Enemy
                if(state.enemyHp > 0) {
                    let ex = width * 0.75, ey = height * 0.4;
                    let bossColor = state.node === 10 ? '#b026ff' : '#ff4444';
                    
                    if(assets.enemy.complete && assets.enemy.naturalWidth > 0) {
                        ctx.shadowColor = bossColor; ctx.shadowBlur = 20;
                        let size = state.node === 10 ? 150 : 100;
                        ctx.drawImage(assets.enemy, ex - size/2, ey - size/2, size, size);
                        ctx.shadowBlur = 0;
                    } else {
                        // Fallback Square
                        ctx.fillStyle = bossColor; ctx.fillRect(ex-30, ey-30, 60, 60);
                    }
                    
                    // Enemy Health Bar (In-World)
                    let pct = state.enemyHp / state.enemyMaxHp;
                    ctx.fillStyle = '#333'; ctx.fillRect(ex-40, ey-60, 80, 6);
                    ctx.fillStyle = bossColor; ctx.fillRect(ex-40, ey-60, 80*pct, 6);
                }
            }

            // Particles
            state.particles.forEach(p => {
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1.0;

            ctx.restore();
        }

        function screenShake(amount) { state.shake = amount; }
        function spawnParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                state.particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 1.0, color: color, size: Math.random()*3
                });
            }
        }

    </script>
</body>
</html>
